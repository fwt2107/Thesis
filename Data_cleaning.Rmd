---
title: "Data_cleaning"
author: "Felix Tran"
date: "October 14, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringr)
```

# Outcome data - CDC WONDER
Suicide rate by county data were retrieved from the CDC WONDER Compressed
Mortality data and exported as a .txt file. Details about the options used when
exporting the data are documented in "CDC wonder query criteria.docx".

These are the steps I took to clean and process the data:

1. The .txt file contained notes about the data at the end of the file. 
These notes were deleted from the dataset, but they can be viewed in 
"CDC wonder notes.docx".

2. I changed some the variable names for the age-adjusted rate 95% CI and 
standard error for ease of use.

2. I created variables to note if the age-adjusted rate for a particular county
was suppressed or unreliable and therefore unusable, or not.

```{r}
cdc_df <- readr::read_tsv('./Raw data/Compressed Mortality, 1999-2016.txt') %>% 
  janitor::clean_names() %>% 
  drop_na(county) %>% 
  select(-notes) %>% 
  select(age_adjusted_lower_ci = 
           age_adjusted_rate_lower_95_percent_confidence_interval, 
         age_adjusted_upper_ci = 
           age_adjusted_rate_upper_95_percent_confidence_interval,
         age_adjusted_se = 
           age_adjusted_rate_standard_error,
         everything()) %>% 
  separate(county, into = c('county', 'state'), sep = ",") %>% 
  mutate(suppressed = if_else(deaths == "Suppressed", T, F),
         unreliable = 
           if_else(str_detect(age_adjusted_rate, "Unreliable"), T, F),
         usable = !(suppressed | unreliable))

usable_counties <- length(which(cdc_df$usable == T))
```

After this initial process I am left with age-adjusted suicide rates for 
`r usable_counties` counties.

Looking at the age-adjusted rates, the distribution of rates looks roughly
normal?
```{r}
cdc_df %>% 
  filter(usable == T) %>% 
  mutate(age_adjusted_rate = as.double(age_adjusted_rate)) %>% 
  ggplot(aes(x = age_adjusted_rate)) +
  geom_histogram(binwidth = 0.5)
```

Plotting the log transformation of the distribution of rates looks roughly
normal.
```{r}
cdc_df %>% 
  filter(usable == T) %>% 
  mutate(age_adjusted_rate = log(as.double(age_adjusted_rate))) %>% 
  ggplot(aes(x = age_adjusted_rate)) +
  geom_histogram(binwidth = 0.1)
```


# Exposure data - ACS 2012-2016 5-year estimates
County-level income inequality was measured using a Gini coefficient and was
retrieved from the American Community Survey 2012-2016 5-year estimates.

These are the steps I took to clean and process this data:

1. Removed an unneeded ID column

2. Renamed variables for ease of use

3. Created a new variable for state
```{r}
acs_exp_df <- read_csv('./Raw data/ACS 2012-2016 Gini.csv', skip = 1) %>% 
  janitor::clean_names() %>% 
  select(-id, 
         county_code = id2, 
         county = geography, 
         gini = estimate_gini_index,
         gini_moe = margin_of_error_gini_index) %>% 
  separate(county, into = c('county', 'state'), sep = ',')
```

Looking at the distribution of gini coefficients across all counties
```{r}
acs_exp_df %>% 
  ggplot(aes(gini)) + 
  geom_histogram(binwidth = 0.001)
```

